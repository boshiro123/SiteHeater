#!/bin/bash

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð‘Ð” Ð¸Ð· Ð±ÑÐºÐ°Ð¿Ð° Ð½Ð° GitHub

set -e

echo "â˜ï¸  Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¸Ð· GitHub"
echo "============================"
echo ""

# ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
PROJECT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "${PROJECT_DIR}"

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ .env
if [ ! -f .env ]; then
    echo "âŒ Ð¤Ð°Ð¹Ð» .env Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½!"
    exit 1
fi

# ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ GitHub
GITHUB_REPO=$(grep BACKUP_GITHUB_REPO .env | cut -d= -f2)
GITHUB_BRANCH=$(grep BACKUP_GITHUB_BRANCH .env | cut -d= -f2)

if [ -z "$GITHUB_REPO" ]; then
    echo "âŒ BACKUP_GITHUB_REPO Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½ Ð² .env"
    exit 1
fi

echo "ðŸ“¦ GitHub Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹: https://github.com/${GITHUB_REPO}"
echo "ðŸŒ¿ Ð’ÐµÑ‚ÐºÐ°: ${GITHUB_BRANCH:-main}"
echo ""

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ
TEMP_DIR="/tmp/siteheater_backups_$$"
mkdir -p "$TEMP_DIR"

echo "ðŸ“¥ ÐšÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ Ñ Ð±ÑÐºÐ°Ð¿Ð°Ð¼Ð¸..."
echo ""

# ÐšÐ»Ð¾Ð½Ð¸Ñ€ÑƒÐµÐ¼ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹
if ! git clone -b "${GITHUB_BRANCH:-main}" "https://github.com/${GITHUB_REPO}.git" "$TEMP_DIR" 2>/dev/null; then
    echo "âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÐºÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹"
    echo ""
    echo "Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ñ‹Ðµ Ð¿Ñ€Ð¸Ñ‡Ð¸Ð½Ñ‹:"
    echo "  1. Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"
    echo "  2. ÐÐµÑ‚ Ð¿Ñ€Ð°Ð² Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° (Ð¿Ñ€Ð¸Ð²Ð°Ñ‚Ð½Ñ‹Ð¹ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹)"
    echo "  3. ÐÐµÐ¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Ðµ Ð¸Ð¼Ñ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ Ð² .env"
    echo ""
    echo "ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÐºÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ:"
    echo "  git clone https://github.com/${GITHUB_REPO}.git"
    rm -rf "$TEMP_DIR"
    exit 1
fi

echo "âœ… Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ ÐºÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½"
echo ""

# ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº Ð±ÑÐºÐ°Ð¿Ð¾Ð²
echo "ðŸ“‹ Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ Ð±ÑÐºÐ°Ð¿Ñ‹ Ð½Ð° GitHub:"
echo ""

cd "$TEMP_DIR"
BACKUPS=$(ls -1 *.sql.gz* 2>/dev/null | sort -r || echo "")

if [ -z "$BACKUPS" ]; then
    echo "âŒ Ð‘ÑÐºÐ°Ð¿Ñ‹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹ Ð² Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¸!"
    rm -rf "$TEMP_DIR"
    exit 1
fi

# ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº Ñ Ð½Ð¾Ð¼ÐµÑ€Ð°Ð¼Ð¸
i=1
declare -A BACKUP_MAP
while IFS= read -r backup; do
    if [ -n "$backup" ]; then
        size=$(du -h "$backup" 2>/dev/null | cut -f1)
        date=$(stat -c '%y' "$backup" 2>/dev/null | cut -d' ' -f1 || stat -f '%Sm' -t '%Y-%m-%d' "$backup" 2>/dev/null)
        echo "$i) $backup (Ð Ð°Ð·Ð¼ÐµÑ€: $size, Ð”Ð°Ñ‚Ð°: $date)"
        BACKUP_MAP[$i]="$backup"
        ((i++))
    fi
done <<< "$BACKUPS"

echo ""
read -p "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð½Ð¾Ð¼ÐµÑ€ Ð±ÑÐºÐ°Ð¿Ð° Ð´Ð»Ñ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ: " choice

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð²Ñ‹Ð±Ð¾Ñ€
if [ -z "${BACKUP_MAP[$choice]}" ]; then
    echo "âŒ ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ð²Ñ‹Ð±Ð¾Ñ€"
    rm -rf "$TEMP_DIR"
    exit 1
fi

BACKUP_FILE="${BACKUP_MAP[$choice]}"

echo ""
echo "âš ï¸  Ð’ÐÐ˜ÐœÐÐÐ˜Ð•! Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð‘Ð” ÑƒÐ´Ð°Ð»Ð¸Ñ‚ Ð’Ð¡Ð• Ñ‚ÐµÐºÑƒÑ‰Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ!"
echo "Ð¤Ð°Ð¹Ð»: ${BACKUP_FILE}"
echo "Ð˜ÑÑ‚Ð¾Ñ‡Ð½Ð¸Ðº: GitHub (${GITHUB_REPO})"
echo ""
read -p "Ð’Ñ‹ ÑƒÐ²ÐµÑ€ÐµÐ½Ñ‹? Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ 'YES' Ð´Ð»Ñ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ: " confirm

if [ "$confirm" != "YES" ]; then
    echo "âŒ ÐžÑ‚Ð¼ÐµÐ½ÐµÐ½Ð¾"
    rm -rf "$TEMP_DIR"
    exit 1
fi

echo ""
echo "ðŸ”„ ÐÐ°Ñ‡Ð¸Ð½Ð°ÐµÐ¼ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¸Ð· GitHub..."
echo ""

# ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð±ÑÐºÐ°Ð¿ Ð² Ð¿Ñ€Ð¾ÐµÐºÑ‚
echo "1ï¸âƒ£ ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð±ÑÐºÐ°Ð¿Ð° Ñ GitHub..."
cp "${BACKUP_FILE}" "${PROJECT_DIR}/"
echo "   âœ… Ð‘ÑÐºÐ°Ð¿ ÑÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½"
echo ""

# ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ
rm -rf "$TEMP_DIR"

# ÐŸÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ð² Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
cd "${PROJECT_DIR}"

# ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð±ÑÐºÐ°Ð¿ Ð² Docker volume
echo "2ï¸âƒ£ Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚ Ð±ÑÐºÐ°Ð¿Ð° Ð² Docker volume..."

# Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ð¹ alpine ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ð´Ð»Ñ ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð² volume
docker run --rm -v siteheater_backup_data:/app/backups -v "${PROJECT_DIR}/${BACKUP_FILE}:/tmp/${BACKUP_FILE}" alpine cp /tmp/${BACKUP_FILE} /app/backups/${BACKUP_FILE}

echo "   âœ… Ð‘ÑÐºÐ°Ð¿ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½"
echo ""

# ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
echo "3ï¸âƒ£ ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ..."
docker-compose stop app
echo "   âœ… ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾"
echo ""

# Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð‘Ð”
echo "4ï¸âƒ£ Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…..."
echo ""

if docker-compose run --rm backup /bin/bash /scripts/restore_db.sh "/app/backups/${BACKUP_FILE}"; then
    echo ""
    echo "   âœ… Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð°"
else
    echo ""
    echo "   âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¸!"
    rm -f "${PROJECT_DIR}/${BACKUP_FILE}"
    exit 1
fi

echo ""

# Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½ÑƒÑŽ ÐºÐ¾Ð¿Ð¸ÑŽ Ð±ÑÐºÐ°Ð¿Ð°
rm -f "${PROJECT_DIR}/${BACKUP_FILE}"

# Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
echo "5ï¸âƒ£ Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ..."
docker-compose start app
echo "   âœ… ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð¾"
echo ""

# ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ°
echo "â³ ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ° (5 ÑÐµÐºÑƒÐ½Ð´)..."
sleep 5

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð»Ð¾Ð³Ð¾Ð²
echo ""
echo "ðŸ“Š ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ Ð»Ð¾Ð³Ð¸ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ:"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
docker-compose logs --tail=20 app
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

echo "âœ¨ Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¸Ð· GitHub Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾!"
echo ""
echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ Ð±Ð¾Ñ‚Ð°:"
echo "  1. ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ Telegram Ð±Ð¾Ñ‚"
echo "  2. ÐžÑ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ /start"
echo "  3. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ ÑÐ¿Ð¸ÑÐ¾Ðº Ð´Ð¾Ð¼ÐµÐ½Ð¾Ð²: /domains"
echo ""
echo "Ð”Ð»Ñ Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð° Ð¿Ð¾Ð»Ð½Ñ‹Ñ… Ð»Ð¾Ð³Ð¾Ð²:"
echo "  docker-compose logs -f app"

