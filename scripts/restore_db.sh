#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏–∑ –±—ç–∫–∞–ø–∞
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./restore_db.sh <backup_file>

set -e

# === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ===

if [ -z "$1" ]; then
    echo "‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 <backup_file>"
    echo "–ü—Ä–∏–º–µ—Ä: $0 siteheater_backup_20250112_120000.sql.gz"
    exit 1
fi

BACKUP_FILE="$1"

# PostgreSQL –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
PGUSER="${POSTGRES_USER:-siteheater}"
PGPASSWORD="${POSTGRES_PASSWORD:-siteheater_password}"
PGDATABASE="${POSTGRES_DB:-siteheater}"
PGHOST="${POSTGRES_HOST:-postgres}"

# === –§–£–ù–ö–¶–ò–ò ===

log() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1"
}

error_exit() {
    log "ERROR: $1"
    exit 1
}

# === –ü–†–û–í–ï–†–ö–ê –§–ê–ô–õ–ê ===

if [ ! -f "$BACKUP_FILE" ]; then
    error_exit "–§–∞–π–ª –±—ç–∫–∞–ø–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω: $BACKUP_FILE"
fi

log "üì¶ –ù–∞–π–¥–µ–Ω —Ñ–∞–π–ª –±—ç–∫–∞–ø–∞: $BACKUP_FILE"

# === –†–ê–°–®–ò–§–†–û–í–ö–ê (–µ—Å–ª–∏ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω) ===

if [[ "$BACKUP_FILE" == *.enc ]]; then
    if [ -z "$BACKUP_ENCRYPTION_KEY" ]; then
        error_exit "–¢—Ä–µ–±—É–µ—Ç—Å—è BACKUP_ENCRYPTION_KEY –¥–ª—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏"
    fi
    
    log "üîê –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –±—ç–∫–∞–ø–∞..."
    
    DECRYPTED_FILE="${BACKUP_FILE%.enc}"
    
    if openssl enc -aes-256-cbc -d -pbkdf2 -in "$BACKUP_FILE" -out "$DECRYPTED_FILE" -k "$BACKUP_ENCRYPTION_KEY"; then
        BACKUP_FILE="$DECRYPTED_FILE"
        log "‚úÖ –ë—ç–∫–∞–ø —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω"
    else
        error_exit "–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å –±—ç–∫–∞–ø"
    fi
fi

# === –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï ===

echo ""
echo "‚ö†Ô∏è  ========================================= ‚ö†Ô∏è"
echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï! –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö    ‚ö†Ô∏è"
echo "‚ö†Ô∏è  ========================================= ‚ö†Ô∏è"
echo ""
echo "–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –∑–∞–º–µ–Ω–∏—Ç —Ç–µ–∫—É—â—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –Ω–∞:"
echo "  –§–∞–π–ª: $BACKUP_FILE"
echo "  –ë–∞–∑–∞: $PGDATABASE@$PGHOST"
echo ""
read -p "–í—ã —É–≤–µ—Ä–µ–Ω—ã? (–≤–≤–µ–¥–∏—Ç–µ YES –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è): " CONFIRM

if [ "$CONFIRM" != "YES" ]; then
    log "‚ùå –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ"
    exit 0
fi

# === –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï ===

log "üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."

# –≠–∫—Å–ø–æ—Ä—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
export PGPASSWORD

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
log "‚è∏Ô∏è  –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π..."
psql -h "$PGHOST" -U "$PGUSER" -d postgres -c "SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE datname = '$PGDATABASE' AND pid <> pg_backend_pid();" || true

# –£–¥–∞–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –±–∞–∑—ã
log "üóëÔ∏è  –£–¥–∞–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –±–∞–∑—ã..."
dropdb -h "$PGHOST" -U "$PGUSER" "$PGDATABASE" --if-exists || error_exit "–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö"

# –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –±–∞–∑—ã
log "üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –±–∞–∑—ã..."
createdb -h "$PGHOST" -U "$PGUSER" "$PGDATABASE" || error_exit "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö"

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –±—ç–∫–∞–ø–∞
log "‚è≥ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –±—ç–∫–∞–ø–∞..."

if gunzip -c "$BACKUP_FILE" | psql -h "$PGHOST" -U "$PGUSER" -d "$PGDATABASE"; then
    log "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!"
    log "üéâ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"
else
    error_exit "–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö"
fi

# –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
if [[ "$BACKUP_FILE" == *".dec" ]]; then
    rm -f "$BACKUP_FILE"
    log "üßπ –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã —É–¥–∞–ª–µ–Ω—ã"
fi

log "‚ú® –ì–æ—Ç–æ–≤–æ! –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π."

