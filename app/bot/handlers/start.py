"""
–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
"""
import logging

from aiogram import Router
from aiogram.filters import CommandStart, Command
from aiogram.types import Message

from app.core.db import db_manager

logger = logging.getLogger(__name__)

router = Router()


@router.message(CommandStart())
async def cmd_start(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    pending = await db_manager.get_pending_client_by_username_or_phone(
        username=message.from_user.username,
        phone=None  # Telegram –Ω–µ –ø–µ—Ä–µ–¥–∞–µ—Ç phone —á–µ—Ä–µ–∑ API
    )
    
    # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (middleware —É–∂–µ —Å–æ–∑–¥–∞–ª/–æ–±–Ω–æ–≤–∏–ª –µ–≥–æ)
    user = await db_manager.register_user(
        user_id=message.from_user.id,
        username=message.from_user.username,
        first_name=message.from_user.first_name,
        last_name=message.from_user.last_name
    )
    
    # –ï—Å–ª–∏ –±—ã–ª–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ - –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–ª–∏–µ–Ω—Ç–∞ –∏ —É–¥–∞–ª—è–µ–º –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ
    if pending:
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–æ–ª—å –∫–ª–∏–µ–Ω—Ç–∞
        user = await db_manager.set_user_role(user.id, "client")
        
        # –£–¥–∞–ª—è–µ–º –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ
        await db_manager.delete_pending_client(pending.id)
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Å–æ–±–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
        await message.answer(
            "‚úÖ <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</b>\n\n"
            "–í–∞—à –∞–∫–∫–∞—É–Ω—Ç —É—Å–ø–µ—à–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!\n\n"
            "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç —Ç–µ–ø–µ—Ä—å –ø—Ä–∏–≤—è–∑–∞—Ç—å –∫ –≤–∞–º –¥–æ–º–µ–Ω—ã.\n"
            "–ü–æ—Å–ª–µ –ø—Ä–∏–≤—è–∑–∫–∏ –¥–æ–º–µ–Ω–æ–≤ –≤—ã —Å–º–æ–∂–µ—Ç–µ:\n"
            "‚Ä¢ –ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –∏—Ö —á–µ—Ä–µ–∑ /domains\n"
            "‚Ä¢ –ü–æ–ª—É—á–∞—Ç—å –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –æ—Ç—á–µ—Ç—ã –≤ 9:00\n\n"
            "<b>–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</b>\n"
            "/domains - –í–∞—à–∏ –¥–æ–º–µ–Ω—ã\n"
            "/status - –ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–≥—Ä–µ–≤—ã\n"
            "/help - –°–ø—Ä–∞–≤–∫–∞",
            parse_mode="HTML"
        )
        
        logger.info(f"Activated client {user.id} from pending invitation")
        return
    
    if user.role == "admin":
        welcome_text = """
üî• <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä!</b>

–≠—Ç–æ—Ç –±–æ—Ç –ø–æ–º–æ–∂–µ—Ç –≤–∞–º "–ø—Ä–æ–≥—Ä–µ–≤–∞—Ç—å" –∫—ç—à —Å–∞–π—Ç–æ–≤ –≤–∞—à–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–µ—â–∞—è –∏—Ö —Å—Ç—Ä–∞–Ω–∏—Ü—ã.

<b>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</b>
/clients - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞–º–∏
/add_client - –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
/add <i>&lt;domain&gt;</i> - –î–æ–±–∞–≤–∏—Ç—å –¥–æ–º–µ–Ω
/domains - –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –¥–æ–º–µ–Ω–æ–≤
/status - –ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–≥—Ä–µ–≤—ã
/help - –°–ø—Ä–∞–≤–∫–∞

<b>–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?</b>
1Ô∏è‚É£ –î–æ–±–∞–≤—å—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ —á–µ—Ä–µ–∑ /add_client
2Ô∏è‚É£ –î–æ–±–∞–≤—å—Ç–µ –¥–æ–º–µ–Ω –∏ –ø—Ä–∏–≤—è–∂–∏—Ç–µ –∫ –∫–ª–∏–µ–Ω—Ç—É
3Ô∏è‚É£ –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∏–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Ä–∞–∑–æ–≤—ã–π –ø—Ä–æ–≥—Ä–µ–≤
4Ô∏è‚É£ –ë–æ—Ç –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–µ—â–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—ã

<b>üìä –û—Ç—á–µ—Ç—ã:</b>
–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –æ—Ç—á–µ—Ç—ã –ø—Ä–∏—Ö–æ–¥—è—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ 9:00
        """
    elif user.role == "client":
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É –∫–ª–∏–µ–Ω—Ç–∞ –¥–æ–º–µ–Ω—ã
        domains = await db_manager.get_domains_by_client(user.id)
        
        if domains:
            welcome_text = f"""
‚úÖ <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</b>

–£ –≤–∞—Å <b>{len(domains)}</b> {'—Å–∞–π—Ç' if len(domains) == 1 else '—Å–∞–π—Ç–∞' if len(domains) < 5 else '—Å–∞–π—Ç–æ–≤'} –≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–µ.

<b>–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</b>
/domains - –ü—Ä–æ—Å–º–æ—Ç—Ä –≤–∞—à–∏—Ö —Å–∞–π—Ç–æ–≤
/help - –°–ø—Ä–∞–≤–∫–∞

<b>üìä –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –æ—Ç—á–µ—Ç—ã:</b>
–ö–∞–∂–¥–æ–µ —É—Ç—Ä–æ –≤ 9:00 –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ –ø–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç—á–µ—Ç –æ —Ä–∞–±–æ—Ç–µ –≤–∞—à–∏—Ö —Å–∞–π—Ç–æ–≤ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞.

üí° <i>–ù–∞—à–∞ —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–ª–µ–¥–∏—Ç –∑–∞ –±—ã—Å—Ç—Ä–æ–¥–µ–π—Å—Ç–≤–∏–µ–º –≤–∞—à–∏—Ö —Å–∞–π—Ç–æ–≤</i>

–ü–æ –≤—Å–µ–º –≤–æ–ø—Ä–æ—Å–∞–º –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.
            """
        else:
            welcome_text = """
‚úÖ <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</b>

–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö —Å–∞–π—Ç–æ–≤.

–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤–∞—à–∏—Ö —Å–∞–π—Ç–æ–≤ –∫ —Å–∏—Å—Ç–µ–º–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.

<b>–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</b>
/help - –°–ø—Ä–∞–≤–∫–∞
            """
    else:
        # –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Ä–æ–ª—å (–Ω–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å)
        welcome_text = """
üëã <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</b>

–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.
        """
    
    await message.answer(welcome_text.strip(), parse_mode="HTML")


@router.message(Command("g8ve_8adm1N_2_m3"))
async def cmd_become_admin(message: Message):
    """–°–µ–∫—Ä–µ—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"""
    user_id = message.from_user.id
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–æ–ª—å –∞–¥–º–∏–Ω–∞
    user = await db_manager.set_user_role(user_id, "admin")
    
    if user:
        await message.answer(
            "üéâ <b>–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</b>\n\n"
            "–í—ã –ø–æ–ª—É—á–∏–ª–∏ –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.\n\n"
            "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n"
            "/clients - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞–º–∏\n"
            "/add_client - –î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞\n"
            "/domains - –í—Å–µ –¥–æ–º–µ–Ω—ã\n"
            "/add - –î–æ–±–∞–≤–∏—Ç—å –¥–æ–º–µ–Ω",
            parse_mode="HTML"
        )
        logger.info(f"User {user_id} ({message.from_user.username}) became admin")
    else:
        await message.answer("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.")

